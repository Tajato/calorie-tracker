<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calorie Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            color: white;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .profile-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .profile-item {
            text-align: center;
        }

        .profile-item h4 {
            margin-bottom: 8px;
            color: #555;
            font-size: 0.9rem;
        }

        .profile-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            text-align: center;
            font-weight: bold;
        }

        .profile-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .update-profile-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        .calories-overview {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            text-align: center;
            margin-bottom: 15px;
        }

        .calorie-stat {
            padding: 15px 10px;
            border-radius: 12px;
        }

        .goal {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .consumed {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .remaining {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
        }

        .remaining.over {
            background: linear-gradient(135deg, #ff9a9e, #fecfef);
            color: #721c24;
        }

        .calorie-stat h4 {
            font-size: 0.8rem;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .calorie-stat .number {
            font-size: 1.4rem;
            font-weight: bold;
        }

        .macros-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .macro-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid;
        }

        .macro-item.protein { border-left-color: #ff6b6b; }
        .macro-item.carbs { border-left-color: #4ecdc4; }
        .macro-item.fat { border-left-color: #feca57; }
        .macro-item.sugar { border-left-color: #ff9ff3; }
        .macro-item.sodium { border-left-color: #54a0ff; }
        .macro-item.fiber { border-left-color: #5f27cd; }

        .macro-item h5 {
            font-size: 0.7rem;
            margin-bottom: 3px;
            color: #666;
            text-transform: uppercase;
        }

        .macro-item .amount {
            font-weight: bold;
            font-size: 0.9rem;
            color: #333;
        }

        .scan-section {
            text-align: center;
        }

        .scan-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(238, 90, 82, 0.4);
        }

        .scan-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(238, 90, 82, 0.6);
        }

        .scan-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .scanner-container {
            position: relative;
            margin: 20px 0;
            border-radius: 15px;
            overflow: hidden;
            display: none;
        }

        #scanner {
            width: 100%;
            height: 280px;
            background: #000;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid #ff6b6b;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 107, 107, 0.1) 30%, rgba(255, 107, 107, 0.1) 70%, transparent 70%);
            pointer-events: none;
        }

        .close-scanner {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
        }

        .manual-input {
            margin-top: 20px;
        }

        .manual-input h3 {
            margin-bottom: 15px;
            color: #555;
            font-size: 1.1rem;
        }

        .input-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #666;
            font-size: 0.9rem;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .macro-inputs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .macro-input {
            padding: 8px;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            font-size: 0.8rem;
            text-align: center;
        }

        .add-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

        .add-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(68, 160, 141, 0.4);
        }

        .food-log h3 {
            margin-bottom: 15px;
            color: #555;
        }

        .food-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
        }

        .food-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .food-details h4 {
            margin: 0;
            color: #333;
            font-size: 0.95rem;
        }

        .food-details p {
            margin: 0;
            color: #666;
            font-size: 0.8rem;
        }

        .food-calories {
            font-weight: bold;
            color: #ff6b6b;
            font-size: 1rem;
        }

        .food-macros {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
            font-size: 0.7rem;
            color: #666;
        }

        .food-macros span {
            text-align: center;
            padding: 2px;
        }

        .delete-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            margin-left: 8px;
        }

        .status {
            text-align: center;
            padding: 8px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e1e5e9;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
            transition: width 0.3s ease;
        }

        .progress-fill.over {
            background: linear-gradient(90deg, #ff6b6b, #ee5a52);
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .calories-overview {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .calorie-stat {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💪 CalTracker Pro</h1>
            <p>Track calories, macros & reach your goals</p>
        </div>

        <!-- Profile Setup -->
        <div class="card">
            <div class="profile-section">
                <div class="profile-item">
                    <h4>Current Weight</h4>
                    <input type="number" class="profile-input" id="currentWeight" placeholder="lbs">
                </div>
                <div class="profile-item">
                    <h4>Daily Calorie Goal</h4>
                    <input type="number" class="profile-input" id="calorieGoal" placeholder="cal">
                </div>
            </div>
            <button class="update-profile-btn" id="updateProfile">Update Profile</button>
        </div>

        <!-- Calories Overview -->
        <div class="card">
            <div class="calories-overview">
                <div class="calorie-stat goal">
                    <h4>Goal</h4>
                    <div class="number" id="goalCalories">2000</div>
                </div>
                <div class="calorie-stat consumed">
                    <h4>Eaten</h4>
                    <div class="number" id="consumedCalories">0</div>
                </div>
                <div class="calorie-stat remaining" id="remainingCard">
                    <h4>Remaining</h4>
                    <div class="number" id="remainingCalories">2000</div>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <!-- Macros Summary -->
            <div class="macros-grid">
                <div class="macro-item protein">
                    <h5>Protein</h5>
                    <div class="amount" id="totalProtein">0g</div>
                </div>
                <div class="macro-item carbs">
                    <h5>Carbs</h5>
                    <div class="amount" id="totalCarbs">0g</div>
                </div>
                <div class="macro-item fat">
                    <h5>Fat</h5>
                    <div class="amount" id="totalFat">0g</div>
                </div>
                <div class="macro-item sugar">
                    <h5>Sugar</h5>
                    <div class="amount" id="totalSugar">0g</div>
                </div>
                <div class="macro-item sodium">
                    <h5>Sodium</h5>
                    <div class="amount" id="totalSodium">0mg</div>
                </div>
                <div class="macro-item fiber">
                    <h5>Fiber</h5>
                    <div class="amount" id="totalFiber">0g</div>
                </div>
            </div>
        </div>

        <!-- Barcode Scanner -->
        <div class="card">
            <div class="scan-section">
                <button class="scan-btn" id="startScan">📱 Scan Barcode</button>
                
                <!-- Test barcode input for debugging -->
                <div style="margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 8px; font-size: 0.8rem;">
                    <p style="margin-bottom: 5px; color: #666;">Having trouble scanning? Try these test barcodes:</p>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <button onclick="lookupProduct('737628064502')" style="background: #667eea; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Honey Nut Cheerios</button>
                        <button onclick="lookupProduct('028400064057')" style="background: #667eea; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Coca Cola</button>
                        <button onclick="lookupProduct('041780003508')" style="background: #667eea; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Red Apple</button>
                    </div>
                    <input type="text" id="testBarcode" placeholder="Or enter barcode manually" style="width: 70%; margin: 5px 0; padding: 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.8rem;">
                    <button onclick="lookupProduct(document.getElementById('testBarcode').value)" style="background: #4ecdc4; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Test Lookup</button>
                </div>
                
                <div class="scanner-container" id="scannerContainer">
                    <button class="close-scanner" id="closeScanner">✕</button>
                    <div id="scanner"></div>
                    <div class="scanner-overlay">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 100px; border: 2px solid #ff6b6b; background: rgba(255, 107, 107, 0.1);"></div>
                        <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: white; background: rgba(0,0,0,0.7); padding: 8px 12px; border-radius: 6px; font-size: 0.8rem;">
                            Position barcode in the box above
                        </div>
                    </div>
                </div>
                <div id="status"></div>
            </div>

            <div class="manual-input">
                <h3>Or Add Manually</h3>
                <div class="input-row">
                    <div class="input-group">
                        <label for="foodName">Food Name</label>
                        <input type="text" id="foodName" placeholder="e.g., Apple, Banana">
                    </div>
                    <div class="input-group">
                        <label for="calories">Calories</label>
                        <input type="number" id="calories" placeholder="95">
                    </div>
                </div>
                <div class="input-group">
                    <label for="serving">Serving Size</label>
                    <input type="text" id="serving" placeholder="1 medium, 100g">
                </div>
                
                <div class="macro-inputs">
                    <input type="number" class="macro-input" id="protein" placeholder="Protein (g)" step="0.1">
                    <input type="number" class="macro-input" id="carbs" placeholder="Carbs (g)" step="0.1">
                    <input type="number" class="macro-input" id="fat" placeholder="Fat (g)" step="0.1">
                    <input type="number" class="macro-input" id="sugar" placeholder="Sugar (g)" step="0.1">
                    <input type="number" class="macro-input" id="sodium" placeholder="Sodium (mg)" step="1">
                    <input type="number" class="macro-input" id="fiber" placeholder="Fiber (g)" step="0.1">
                </div>
                
                <button class="add-btn" id="addManual">Add Food</button>
            </div>
        </div>

        <!-- Food Log -->
        <div class="card">
            <div class="food-log">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>Today's Food Log</h3>
                    <button onclick="clearTodaysLog()" style="background: #ff6b6b; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer;">Clear Today</button>
                </div>
                <div id="foodList"></div>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; text-align: center;">
                    <button onclick="exportData()" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 0.8rem; cursor: pointer;">📥 Export Data</button>
                    <p style="font-size: 0.7rem; color: #999; margin-top: 8px;">Data automatically resets each day at midnight</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let foodLog = [];
        let scannerActive = false;
        let userProfile = {
            weight: 150,
            calorieGoal: 2000
        };

        // DOM elements
        const startScanBtn = document.getElementById('startScan');
        const scannerContainer = document.getElementById('scannerContainer');
        const closeScannerBtn = document.getElementById('closeScanner');
        const status = document.getElementById('status');
        const foodList = document.getElementById('foodList');
        const addManualBtn = document.getElementById('addManual');
        const updateProfileBtn = document.getElementById('updateProfile');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadUserProfile();
            loadFoodLog();
            updateDisplay();
        });

        // Profile management
        updateProfileBtn.addEventListener('click', function() {
            const weight = parseFloat(document.getElementById('currentWeight').value) || userProfile.weight;
            const goal = parseInt(document.getElementById('calorieGoal').value) || userProfile.calorieGoal;
            
            userProfile.weight = weight;
            userProfile.calorieGoal = goal;
            
            saveUserProfile();
            updateDisplay();
            showStatus('Profile updated!', 'success');
        });

        // Barcode scanning functionality
        startScanBtn.addEventListener('click', function() {
            if (!scannerActive) {
                startScanner();
            }
        });

        closeScannerBtn.addEventListener('click', function() {
            stopScanner();
        });

        function startScanner() {
            showStatus('Requesting camera access...', 'loading');
            scannerContainer.style.display = 'block';
            scannerActive = true;
            startScanBtn.disabled = true;

            // Enhanced scanner configuration
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner'),
                    constraints: {
                        width: { min: 320, ideal: 640, max: 800 },
                        height: { min: 240, ideal: 480, max: 600 },
                        facingMode: "environment", // Use back camera
                        aspectRatio: { min: 1, max: 100 },
                        frameRate: { min: 10, max: 30 }
                    },
                    area: { // Define scanning area
                        top: "20%",
                        right: "10%", 
                        left: "10%",
                        bottom: "20%"
                    },
                    singleChannel: false
                },
                locator: {
                    patchSize: "medium",
                    halfSample: true
                },
                numOfWorkers: 2,
                frequency: 10,
                decoder: {
                    readers: [
                        "ean_reader",
                        "ean_8_reader", 
                        "ean_5_reader",
                        "code_128_reader",
                        "code_39_reader",
                        "upc_reader",
                        "upc_e_reader",
                        "i2of5_reader"
                    ],
                    debug: {
                        showCanvas: false,
                        showPatches: false,
                        showFoundPatches: false,
                        showSkeleton: false,
                        showLabels: false,
                        showPatchLabels: false,
                        showRemainingPatchLabels: false,
                        boxFromPatches: {
                            showTransformed: false,
                            showTransformedBox: false,
                            showBB: false
                        }
                    }
                },
                locate: true
            }, function(err) {
                if (err) {
                    console.error('Scanner initialization error:', err);
                    let errorMsg = 'Scanner initialization failed';
                    
                    if (err.name === 'NotAllowedError') {
                        errorMsg = 'Camera access denied. Please allow camera permissions and try again.';
                    } else if (err.name === 'NotFoundError') {
                        errorMsg = 'No camera found on this device';
                    } else if (err.name === 'NotSupportedError') {
                        errorMsg = 'Camera not supported on this device';
                    } else if (err.name === 'NotReadableError') {
                        errorMsg = 'Camera is in use by another application';
                    }
                    
                    showStatus(errorMsg, 'error');
                    stopScanner();
                    return;
                }
                
                console.log('Scanner initialized successfully');
                showStatus('Camera ready! Point at barcode and hold steady', 'loading');
                
                try {
                    Quagga.start();
                    console.log('Scanner started');
                } catch (startErr) {
                    console.error('Scanner start error:', startErr);
                    showStatus('Failed to start camera', 'error');
                    stopScanner();
                }
            });
        }

        function stopScanner() {
            if (scannerActive) {
                Quagga.stop();
                scannerContainer.style.display = 'none';
                scannerActive = false;
                startScanBtn.disabled = false;
                clearStatus();
            }
        }

        // Enhanced barcode detection with better feedback
        Quagga.onProcessed(function(result) {
            var drawingCtx = Quagga.canvas.ctx.overlay,
                drawingCanvas = Quagga.canvas.dom.overlay;

            if (result) {
                if (result.boxes) {
                    drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                    result.boxes.filter(function (box) {
                        return box !== result.box;
                    }).forEach(function (box) {
                        Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                    });
                }

                if (result.box) {
                    Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
                }

                if (result.codeResult && result.codeResult.code) {
                    Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
                }
            }
        });

        // Barcode detection with validation
        Quagga.onDetected(function(data) {
            const barcode = data.codeResult.code;
            const format = data.codeResult.format;
            
            console.log('Barcode detected:', barcode, 'Format:', format);
            
            // Validate barcode length and format
            if (barcode && barcode.length >= 8) {
                showStatus(`Barcode detected: ${barcode}`, 'success');
                
                // Add a small delay to show the success message
                setTimeout(() => {
                    showStatus('Looking up product...', 'loading');
                    stopScanner();
                    lookupProduct(barcode);
                }, 1000);
            } else {
                console.log('Invalid barcode detected:', barcode);
                showStatus('Invalid barcode detected, keep trying...', 'error');
            }
        });

        // Product lookup with enhanced macro extraction
        async function lookupProduct(barcode) {
            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                const data = await response.json();
                
                if (data.status === 1 && data.product) {
                    const product = data.product;
                    const name = product.product_name || 'Unknown Product';
                    const nutrients = product.nutriments || {};
                    
                    // Extract nutritional data per 100g
                    const foodData = {
                        name: name,
                        calories: Math.round(nutrients['energy-kcal_100g'] || nutrients['energy_100g'] / 4.184 || 0),
                        serving: '100g',
                        protein: parseFloat(nutrients['proteins_100g'] || 0).toFixed(1),
                        carbs: parseFloat(nutrients['carbohydrates_100g'] || 0).toFixed(1),
                        fat: parseFloat(nutrients['fat_100g'] || 0).toFixed(1),
                        sugar: parseFloat(nutrients['sugars_100g'] || 0).toFixed(1),
                        sodium: Math.round(nutrients['sodium_100g'] * 1000 || nutrients['salt_100g'] * 400 || 0), // Convert to mg
                        fiber: parseFloat(nutrients['fiber_100g'] || 0).toFixed(1)
                    };
                    
                    addFood(foodData);
                    showStatus(`Added ${name} to your log!`, 'success');
                } else {
                    showStatus('Product not found. Please add manually.', 'error');
                    document.getElementById('foodName').value = `Product ${barcode}`;
                    document.getElementById('foodName').focus();
                }
            } catch (error) {
                console.error('Error looking up product:', error);
                showStatus('Unable to lookup product. Please add manually.', 'error');
            }
        }

        // Manual food addition
        addManualBtn.addEventListener('click', function() {
            const name = document.getElementById('foodName').value.trim();
            const calories = parseInt(document.getElementById('calories').value) || 0;
            const serving = document.getElementById('serving').value.trim() || '1 serving';
            
            if (name && calories > 0) {
                const foodData = {
                    name: name,
                    calories: calories,
                    serving: serving,
                    protein: parseFloat(document.getElementById('protein').value || 0).toFixed(1),
                    carbs: parseFloat(document.getElementById('carbs').value || 0).toFixed(1),
                    fat: parseFloat(document.getElementById('fat').value || 0).toFixed(1),
                    sugar: parseFloat(document.getElementById('sugar').value || 0).toFixed(1),
                    sodium: parseInt(document.getElementById('sodium').value || 0),
                    fiber: parseFloat(document.getElementById('fiber').value || 0).toFixed(1)
                };
                
                addFood(foodData);
                showStatus(`Added ${name} to your log!`, 'success');
                clearManualForm();
            } else {
                showStatus('Please fill in food name and calories', 'error');
            }
        });

        function clearManualForm() {
            document.getElementById('foodName').value = '';
            document.getElementById('calories').value = '';
            document.getElementById('serving').value = '';
            document.getElementById('protein').value = '';
            document.getElementById('carbs').value = '';
            document.getElementById('fat').value = '';
            document.getElementById('sugar').value = '';
            document.getElementById('sodium').value = '';
            document.getElementById('fiber').value = '';
        }

        // Add food to log
        function addFood(foodData) {
            const food = {
                id: Date.now(),
                ...foodData,
                timestamp: new Date().toLocaleTimeString()
            };
            
            foodLog.unshift(food);
            saveFoodLog();
            updateDisplay();
        }

        // Delete food item
        function deleteFood(id) {
            foodLog = foodLog.filter(food => food.id !== id);
            saveFoodLog();
            updateDisplay();
        }

        // Update all displays
        function updateDisplay() {
            updateCaloriesOverview();
            updateMacrosSummary();
            updateFoodList();
            updateProfileInputs();
        }

        function updateCaloriesOverview() {
            const totalCalories = foodLog.reduce((sum, food) => sum + food.calories, 0);
            const remaining = userProfile.calorieGoal - totalCalories;
            const progress = Math.min((totalCalories / userProfile.calorieGoal) * 100, 100);
            
            document.getElementById('goalCalories').textContent = userProfile.calorieGoal;
            document.getElementById('consumedCalories').textContent = totalCalories;
            document.getElementById('remainingCalories').textContent = Math.abs(remaining);
            
            const remainingCard = document.getElementById('remainingCard');
            const progressFill = document.getElementById('progressFill');
            
            if (remaining < 0) {
                remainingCard.className = 'calorie-stat remaining over';
                remainingCard.querySelector('h4').textContent = 'Over';
                progressFill.className = 'progress-fill over';
            } else {
                remainingCard.className = 'calorie-stat remaining';
                remainingCard.querySelector('h4').textContent = 'Remaining';
                progressFill.className = 'progress-fill';
            }
            
            progressFill.style.width = `${progress}%`;
        }

        function updateMacrosSummary() {
            const totals = {
                protein: 0,
                carbs: 0,
                fat: 0,
                sugar: 0,
                sodium: 0,
                fiber: 0
            };
            
            foodLog.forEach(food => {
                totals.protein += parseFloat(food.protein || 0);
                totals.carbs += parseFloat(food.carbs || 0);
                totals.fat += parseFloat(food.fat || 0);
                totals.sugar += parseFloat(food.sugar || 0);
                totals.sodium += parseInt(food.sodium || 0);
                totals.fiber += parseFloat(food.fiber || 0);
            });
            
            document.getElementById('totalProtein').textContent = `${totals.protein.toFixed(1)}g`;
            document.getElementById('totalCarbs').textContent = `${totals.carbs.toFixed(1)}g`;
            document.getElementById('totalFat').textContent = `${totals.fat.toFixed(1)}g`;
            document.getElementById('totalSugar').textContent = `${totals.sugar.toFixed(1)}g`;
            document.getElementById('totalSodium').textContent = `${totals.sodium}mg`;
            document.getElementById('totalFiber').textContent = `${totals.fiber.toFixed(1)}g`;
        }

        function updateFoodList() {
            foodList.innerHTML = '';
            if (foodLog.length === 0) {
                foodList.innerHTML = '<p style="text-align: center; color: #999; font-style: italic;">No food logged today</p>';
            } else {
                foodLog.forEach(food => {
                    const foodItem = document.createElement('div');
                    foodItem.className = 'food-item';
                    foodItem.innerHTML = `
                        <div class="food-header">
                            <div class="food-details">
                                <h4>${food.name}</h4>
                                <p>${food.serving} • ${food.timestamp}</p>
                            </div>
                            <div>
                                <span class="food-calories">${food.calories} cal</span>
                                <button class="delete-btn" onclick="deleteFood(${food.id})">🗑️</button>
                            </div>
                        </div>
                        <div class="food-macros">
                            <span>P: ${food.protein || 0}g</span>
                            <span>C: ${food.carbs || 0}g</span>
                            <span>F: ${food.fat || 0}g</span>
                            <span>S: ${food.sugar || 0}g</span>
                            <span>Na: ${food.sodium || 0}mg</span>
                            <span>Fib: ${food.fiber || 0}g</span>
                        </div>
                    `;
                    foodList.appendChild(foodItem);
                });
            }
        }

        function updateProfileInputs() {
            document.getElementById('currentWeight').value = userProfile.weight;
            document.getElementById('calorieGoal').value = userProfile.calorieGoal;
        }

        // Status messages
        function showStatus(message, type) {
            status.innerHTML = `<div class="status ${type}">${message}</div>`;
            if (type === 'success' || type === 'error') {
                setTimeout(clearStatus, 3000);
            }
        }

        function clearStatus() {
            status.innerHTML = '';
        }

        // Storage functions with localStorage fallback
        function saveUserProfile() {
            try {
                localStorage.setItem('calorieTracker_userProfile', JSON.stringify(userProfile));
            } catch (e) {
                // Fallback to memory storage if localStorage isn't available
                window.userProfileData = userProfile;
            }
        }

        function loadUserProfile() {
            try {
                const saved = localStorage.getItem('calorieTracker_userProfile');
                if (saved) {
                    userProfile = { ...userProfile, ...JSON.parse(saved) };
                }
            } catch (e) {
                // Fallback to memory storage
                const saved = window.userProfileData;
                if (saved) {
                    userProfile = { ...userProfile, ...saved };
                }
            }
        }

        function saveFoodLog() {
            const today = new Date().toDateString();
            const data = { date: today, foods: foodLog };
            try {
                localStorage.setItem('calorieTracker_foodLog', JSON.stringify(data));
            } catch (e) {
                // Fallback to memory storage
                window.calorieTrackerData = data;
            }
        }

        function loadFoodLog() {
            const today = new Date().toDateString();
            let data = null;
            
            try {
                const saved = localStorage.getItem('calorieTracker_foodLog');
                if (saved) {
                    data = JSON.parse(saved);
                }
            } catch (e) {
                // Fallback to memory storage
                data = window.calorieTrackerData;
            }
            
            // Check if data is from today, if not start fresh
            if (data && data.date === today) {
                foodLog = data.foods || [];
            } else {
                foodLog = [];
                // If it's a new day, save the empty log immediately
                if (data && data.date !== today) {
                    saveFoodLog();
                    showStatus(`New day started! Previous log cleared.`, 'success');
                }
            }
        }

        // Function to manually clear today's log (useful for testing or reset)
        function clearTodaysLog() {
            if (confirm('Are you sure you want to clear today\'s food log?')) {
                foodLog = [];
                saveFoodLog();
                updateDisplay();
                showStatus('Today\'s food log cleared!', 'success');
            }
        }

        // Function to export/backup data (useful for users)
        function exportData() {
            const exportData = {
                profile: userProfile,
                foodLog: {
                    date: new Date().toDateString(),
                    foods: foodLog
                },
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `calorie-tracker-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // Prevent scanner from running when page is hidden
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && scannerActive) {
                stopScanner();
            }
        });
    </script>
</body>
</html>